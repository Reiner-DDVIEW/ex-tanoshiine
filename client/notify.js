(function () {

// Should be part of a greater thread model
var Unread = new Backbone.Model({unreadCount: 0});

// Remember replies that don't need a new desktop notification for 30 days
var Replies = new Kioku('replies', 30);
var readReplies = Replies.read_all();
Replies.purge_expired_soon();

var normalTitle = document.title;

// Pass visibility changes to Unread model
window.addEventListener('focus', function () {
	Unread.set({hidden: false, unreadCount: 0, reply: true});
	autoUnlock(false);
}, false);

window.addEventListener('blur', function () {
	Unread.set({hidden: true, unreadCount: 0, reply: false});
	autoUnlock(true);
}, false);

connSM.on('synced', function () {
	Unread.set('alert', false);
});

function dropped() {
	Unread.set('alert', true);
}
connSM.on('dropped', dropped);
connSM.on('desynced', dropped);

Backbone.on('repliedToMe', function (post) {
	var num = post.get('num');
	// Already read reply || catalog view
	if (readReplies[num]|| CATALOG)
		return;
	if (options.get('beepbox')) {
		//http://freesound.org/people/pierrecartoons1979/sounds/90112/
		//cc-by-nc-3.0
		if (!$('#beep').length) {
			var beep = 'data:audio/wav;base64,UklGRjQDAABXQVZFZm10IBAAAAABAAEAgD4AAIA+AAABAAgAc21wbDwAAABBAAADAAAAAAAAAAA8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABkYXRhzAIAAGMms8em0tleMV4zIpLVo8nhfSlcPR102Ki+5JspVEkdVtKzs+K1NEhUIT7DwKrcy0g6WygsrM2k1NpiLl0zIY/WpMrjgCdbPhxw2Kq+5Z4qUkkdU9K1s+K5NkVTITzBwqnczko3WikrqM+l1NxlLF0zIIvXpsnjgydZPhxs2ay95aIrUEkdUdC3suK8N0NUIjq+xKrcz002WioppdGm091pK1w0IIjYp8jkhydXPxxq2K295aUrTkoeTs65suK+OUFUIzi7xqrb0VA0WSoootKm0t5tKlo1H4TYqMfkiydWQBxm16+85actTEseS8y7seHAPD9TIza5yKra01QyWSson9On0d5wKVk2H4DYqcfkjidUQB1j1rG75KsvSkseScu8seDCPz1TJDW2yara1FYxWSwnm9Sn0N9zKVg2H33ZqsXkkihSQR1g1bK65K0wSEsfR8i+seDEQTxUJTOzy6rY1VowWC0mmNWoz993KVc3H3rYq8TklSlRQh1d1LS647AyR0wgRMbAsN/GRDpTJTKwzKrX1l4vVy4lldWpzt97KVY4IXbUr8LZljVPRCxhw7W3z6ZISkw1VK+4sMWvXEhSPk6buay9sm5JVkZNiLWqtrJ+TldNTnquqbCwilZXU1BwpKirrpNgWFhTaZmnpquZbFlbVmWOpaOonHZcXlljhaGhpZ1+YWBdYn2cn6GdhmdhYGN3lp2enIttY2Jjco+bnJuOdGZlZXCImJqakHpoZ2Zug5WYmZJ/bGlobX6RlpeSg3BqaW16jZSVkoZ0bGtteImSk5KIeG5tbnaFkJKRinxxbm91gY2QkIt/c3BwdH6Kj4+LgnZxcXR8iI2OjIR5c3J0e4WLjYuFe3VzdHmCioyLhn52dHR5gIiKioeAeHV1eH+GiYqHgXp2dnh9hIiJh4J8eHd4fIKHiIeDfXl4eHyBhoeHhH96eHmA';
			$('<audio/>', {
				id: 'beep',
				src: beep
			}).appendTo($('body'));
			$('#beep')[0].volume = vol ? vol : 0.5;
		}
		if (Unread.get('hidden'))
			$('#beep')[0].play();
	}
	if (options.get('notification')) {
		var body = post.get('body');
		var image = post.get('image');
		if((body || image) && Unread.get('hidden') && !isMobile){
			var n = new Notification('見て見て!',{
				// if the post doesn't have a image we use a bigger favicon
				icon: encodeURI(mediaURL+ (image ? 'thumb/'+image.thumb : 'css/ui/favbig.png')),
				body: body,
			});
			n.onclick = function(){
				window.focus();
				location.hash = '#'+num;
			};
		}
	}
	if (options.get('youCounter')) {
		yC[THREAD]+=1;
		yC.total+=1;
		localStorage.youCounter = JSON.stringify(yC);
		$('#Ycount')[0].html((THREAD?"Thread ":"Front Page ") + "(You)s: " + yC[THREAD] + "<br>Total (You)s: " + yC.total);
	}

	Unread.set({reply: true});
	// Record as already read
	Replies.write(num, Replies.now());
});
Backbone.on('syncCountdown', function(time){
	if (options.get('notification')) {
		if(Unread.get('hidden'))
			new Notification('Syncwatch Starting',{
				body: 'syncwatch starting in : '+time+' seconds',
			});
	}
});
Backbone.on('afterInsert', function (model) {
	if (model && model.get('mine'))
		return; // It's ours, don't notify unread
	if (Unread.get('hidden'))
		Unread.set('unreadCount', Unread.get('unreadCount') + 1);
});

// Change the favicon
function favicon(url){
	$('#favicon').remove();
	$('<link/>', {
		type: 'image/x-icon',
		rel: 'shortcut icon',
		href: url,
		id: 'favicon',
	}).appendTo('head');
}

// Needs to be available with no connectivity
var discoFavicon = 'data:image/vnd.microsoft.icon;base64,AAABAAEAQEAQAAEABABoCgAAFgAAACgAAABAAAAAgAAAAAEABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/AP///wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAREREAAAAAABEREQAAAAAAAAAAERERAAAAAAAREREAABERERAAAAABEREQAAAAAAAAAAAREREQAAAAAREREAAAAREREQAAABERERAAAAAAAAAAAAEREREAAAAREREQAAAAERERAAAAERERAAAAAAAAAAAAABEREQAAABEREQAAAAAREREQAAERERAAAAAAAAAAAAAAEREREAABEREQAAAAAAEREREAEREREAAAAAAAAAAAAAABERERABERERAAAAAAABEREQAREREAAAAAAAAAAAAAAAAREREAERERAAAAAAAAAREREREREAAAAAAAAAAAAAAAAAERERERERAAAAAAAAABEREREREQAAAAAiIiIiIiIAAAAREREREREAAAAAAAAAAREREREQAAAAACIiIiIiIgAAAAEREREREAAAAAAAAAAAEREREQAAAAAAIiIiIiIiAAAAABEREREAAAAAAAAAAAARERERAAAAAAAiIiIiIiIAAAAAEREREQAAAAAAAAAAABEREREAAAAAACIiIiIiIgAAAAARERERAAAAAAAAAAABERERERAAAAAAAAAAAAAAAAAAAREREREQAAAAAAAAAAEREREREAAAAAAAAAAAAAAAAAABERERERAAAAAAAAAAERERERERAAAAAAAAAAAAAAAAABEREREREQAAAAAAAAAREREREREAAAAAAAAAAAAAAAAAERERERERAAAAAAAAAREREAERERAAAAAAAAAAAAAAAAERERABEREQAAAAAAAREREQAREREQAAAAAAAAAAAAAAEREREAEREREAAAAAABEREQAAERERAAAAAAAAAAAAAAAREREAABEREQAAAAABEREQAAAREREQAAAAAAAAAAAAAREREAAAEREREAAAABERERAAAAEREREAAAAAAAAAAAAREREQAAABERERAAAAERERAAAAABEREQAAAAAAAAAAABEREQAAAAAREREAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==';

Unread.on('change', function (model) {
	var attrs = model.attributes;
	var icon = '../favicon.ico';
	if (attrs.alert) {
		document.title = '--- ' + normalTitle;
		return favicon(discoFavicon);
	}
	if (!attrs.hidden) {
		document.title = normalTitle;
		return favicon(icon);
	}
	var prefix = '';
	if (attrs.unreadCount){
		prefix += '(' + attrs.unreadCount + ') ';
		icon = mediaURL + 'css/ui/unreadFavicon.ico';
	}
	if (attrs.reply){
		prefix = '>> ' + prefix;
		icon = mediaURL + 'css/ui/replyFavicon.ico';
	}
	favicon(icon);
	document.title = prefix + normalTitle;
});

})();
